# TaskOnEmbed Class

`TaskOnEmbed` is the core class of the SDK used to embed TaskOn into third-party sites and communicate with the iframe via a message bridge.

## Constructor

```typescript
new TaskOnEmbed(config: TaskOnEmbedConfig)
```

### Parameters

- `config: TaskOnEmbedConfig` - configuration object

### Example

```typescript
import { TaskOnEmbed } from "@taskon/embed";

const embed = new TaskOnEmbed({
  baseUrl: "https://taskon.xyz", // or your white-label domain
  containerElement: "#taskon-container",
  width: "100%",
  height: "100%",
});

// Initialize the iframe
await embed.init();
```

## Properties

### initialized

Read-only property indicating whether the embed has been initialized.

```typescript
get initialized(): boolean
```

#### Example

```typescript
if (embed.initialized) {
  console.log("Embed is ready to use");
}
```

### currentRoute

Get current iframe route.

```typescript
get currentRoute(): string
```

#### Example

```typescript
console.log("Current route:", embed.currentRoute);
```

## Methods

### init()

Initialize the embed iframe and establish communication.

```typescript
init(): Promise<void>
```

#### Example

```typescript
await embed.init();
```

### login()

Request login inside the iframe. Supports both Email and EVM wallet authentication. Can be called when already logged in to switch accounts. Duplicate login with same account will be ignored.

```typescript
login(request: LoginParams): Promise<void>
```

#### Parameters

- `request: LoginParams`

#### Email login example

```typescript
// Check if authorization is needed first
const isAuthorized = await embed.isAuthorized("Email", "user@example.com");

if (!isAuthorized) {
  // First time login - signature required
  await embed.login({
    type: "Email",
    account: "user@example.com",
    signature: serverSignature, // generated by your backend
    timestamp: Date.now(),
  });
} else {
  // Already authorized - no signature needed
  await embed.login({
    type: "Email",
    account: "user@example.com",
  });
}
```

#### EVM wallet login example

```typescript
const isAuthorized = await embed.isAuthorized("WalletAddress", "0x1234...");

if (!isAuthorized) {
  await embed.login({
    type: "WalletAddress",
    account: "0x1234...",
    signature: serverSignature,
    timestamp: Date.now(),
    provider: window.ethereum, // Required for wallet operations
  });
} else {
  await embed.login({
    type: "WalletAddress",
    account: "0x1234...",
    provider: window.ethereum,
  });
}
```

#### Cross-account login example

```typescript
// Switch directly from userA to userB without logout
await embed.login({
  type: "Email",
  account: "userB@example.com",
  signature: userBSignature, // Required if userB not authorized yet
  timestamp: userBTimestamp,
});
```

### logout()

Request logout from current session with optional authorization cache control.

```typescript
logout(options?: LogoutOptions): Promise<void>
```

#### Parameters

- `options?: LogoutOptions` - Optional logout configuration
  - `clearAuth?: boolean` - Whether to clear authorization cache (default: false)
    - `false`: Keep auth cache for quick re-login (recommended for account switching)
    - `true`: Complete logout, clear all authorization cache (use for security-sensitive logout)

#### Examples

````typescript
// Standard logout - keeps auth cache (recommended)
await embed.logout();;

// Complete logout - clears all authorization (use sparingly)
await embed.logout({ clearAuth: true });

### isAuthorized()

Check if the specified account has valid authorization cache. If true, login() can be called without signature/timestamp.

```typescript
isAuthorized(authType: AuthType, account: string): Promise<boolean>
````

#### Parameters

- `authType: AuthType` - Authentication type ("Email" or "WalletAddress")
- `account: string` - Account identifier (email address or wallet address)

#### Returns

- `Promise<boolean>` - true if account has valid authorization cache, false if signature is required

#### Example

```typescript
const isAuthorized = await embed.isAuthorized("Email", "user@example.com");
if (isAuthorized) {
  // No signature needed
  await embed.login({
    type: "Email",
    account: "user@example.com",
  });
} else {
  // Signature required
  const { signature, timestamp } = await getServerSignature("user@example.com");
  await embed.login({
    type: "Email",
    account: "user@example.com",
    signature,
    timestamp,
  });
}
```

### updateSize()

Update iframe size.

```typescript
updateSize(width?: string | number, height?: string | number): void
```

#### Example

```typescript
embed.updateSize("100%", 720);
```

### destroy()

Destroy the instance and release resources.

```typescript
destroy(): void
```

#### Example

```typescript
embed.destroy();
```

### setRoute()

Set iframe internal route.

```typescript
setRoute(fullPath: string): Promise<void>
```

#### Example

```typescript
await embed.setRoute("/profile");
```

## Events

Register events via `embed.on(event, handler)`.

- `loginRequired`: `() => void` - Fired when iframe requires user authentication
- `routeChanged`: `(fullPath: string) => void` - Fired when iframe internal route changes

```typescript
// Triggered when iframe needs user authentication
embed.on("loginRequired", () => {
  console.log("User authentication required");
  // Implement your authentication flow:
  // 1. Show login modal/form
  // 2. Get user credentials
  // 3. Generate signature on server
  // 4. Call embed.login() with signature
});

// Triggered when iframe internal route changes
embed.on("routeChanged", fullPath => {
  console.log("Internal route changed to:", fullPath);
  // Optional: Sync with external URL routing
  // window.history.replaceState(null, '', `/embed${fullPath}`);
});
```

## Complete Example

```typescript
import { TaskOnEmbed, trackVisit } from "@taskon/embed";

const embed = new TaskOnEmbed({
  baseUrl: "https://taskon.xyz",
  containerElement: "#taskon-container",
});

// Initialize the embed
await embed.init();

// Set up event listeners
embed.on("loginRequired", async () => {
  // Handle email login
  const email = "user@example.com";
  const isAuthorized = await embed.isAuthorized("Email", email);

  if (!isAuthorized) {
    const { signature, timestamp } = await fetch("/api/auth/sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ account: email }),
    }).then(r => r.json());

    await embed.login({
      type: "Email",
      account: email,
      signature,
      timestamp,
    });
  } else {
    await embed.login({
      type: "Email",
      account: email,
    });
  }
});

embed.on("routeChanged", fullPath => {
  console.log("Route changed to:", fullPath);
});

// Optional: Track page visit for TaskOn conversion analytics
// Only use if you need conversion rate analysis
// await trackVisit(); // For anonymous users
// or
// await trackVisit('Email', 'user@example.com'); // For known users
```
