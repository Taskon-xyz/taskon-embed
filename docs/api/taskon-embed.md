# TaskOnEmbed Class

`TaskOnEmbed` is the core class of the SDK used to embed TaskOn into third-party sites and communicate with the iframe via a message bridge.

## Constructor

```typescript
new TaskOnEmbed(config: TaskOnEmbedConfig)
```

### Parameters

- `config: TaskOnEmbedConfig` - configuration object

### Example

```typescript
import { TaskOnEmbed } from "@taskon/embed";

const embed = new TaskOnEmbed({
  baseUrl: "https://taskon.xyz", // or your white-label domain
  containerElement: "#taskon-container",
  width: "100%",
  height: 600,
  oauthToolUrl: "https://generalauthservice.com", // optional
});

// Initialize the iframe
await embed.init();
```

## Properties

### initialized

Read-only property indicating whether the embed has been initialized.

```typescript
get initialized(): boolean
```

#### Example

```typescript
if (embed.initialized) {
  console.log("Embed is ready to use");
}
```

### currentRoute

Get current iframe route.

```typescript
get currentRoute(): string
```

#### Example

```typescript
console.log("Current route:", embed.currentRoute);
```

## Methods

### init()

Initialize the embed iframe and establish communication.

```typescript
init(): Promise<void>
```

#### Example

```typescript
await embed.init();
```

### login()

Request login inside the iframe. Supports both Email and EVM wallet.

```typescript
login(request: LoginParams): Promise<void>
```

#### Parameters

- `request: LoginParams`

#### Email login example

```typescript
await embed.login({
  type: "Email",
  account: "user@example.com",
  signature: serverSignature, // generated by your backend
  timestamp: Date.now(),
});
```

#### EVM wallet login example

```typescript
await embed.login({
  type: "WalletAddress",
  account: "0x1234...",
  signature: serverSignature, // backend signature over account
  timestamp: Date.now(),
  provider: window.ethereum, // Required for wallet operations
});
```

> **Note**: When `embed.getIsLoggedIn()` returns true, you can omit `signature` and `timestamp`.

### logout()

Request logout inside the iframe.

```typescript
logout(): Promise<void>
```

#### Example

```typescript
await embed.logout();
```

### getIsLoggedIn()

Check if the user is logged in by iframe. If true, no need to set signature in login request.

```typescript
getIsLoggedIn(authType: AuthType, account: string): Promise<boolean>
```

#### Parameters

- `authType: AuthType` - "Email" or "WalletAddress"
- `account: string` - The credential value (email or EVM address)

#### Example

```typescript
const isLoggedIn = await embed.getIsLoggedIn("Email", "user@example.com");
if (isLoggedIn) {
  console.log("Already logged in");
}
```

### updateSize()

Update iframe size.

```typescript
updateSize(width?: string | number, height?: string | number): void
```

#### Example

```typescript
embed.updateSize("100%", 720);
```

### destroy()

Destroy the instance and release resources.

```typescript
destroy(): void
```

#### Example

```typescript
embed.destroy();
```

### setRoute()

Set iframe internal route.

```typescript
setRoute(fullPath: string): Promise<void>
```

#### Example

```typescript
await embed.setRoute("/profile");
```

## Events

Register events via `embed.on(event, handler)`.

- `loginRequired`: `() => void` - Fired when iframe requires user authentication
- `routeChanged`: `(fullPath: string) => void` - Fired when iframe internal route changes

```typescript
// Triggered when iframe needs user authentication
embed.on("loginRequired", () => {
  console.log("User authentication required");
  // Implement your authentication flow:
  // 1. Show login modal/form
  // 2. Get user credentials
  // 3. Generate signature on server
  // 4. Call embed.login() with signature
});

// Triggered when iframe internal route changes
embed.on("routeChanged", fullPath => {
  console.log("Internal route changed to:", fullPath);
  // Optional: Sync with external URL routing
  // window.history.replaceState(null, '', `/embed${fullPath}`);
});
```

## Complete Example

```typescript
import { TaskOnEmbed, trackVisit } from "@taskon/embed";

const embed = new TaskOnEmbed({
  baseUrl: "https://taskon.xyz",
  containerElement: "#taskon-container",
});

// Initialize the embed
await embed.init();

// Set up event listeners
embed.on("loginRequired", async () => {
  // Handle email login
  const email = "user@example.com";
  const isLoggedIn = await embed.getIsLoggedIn("Email", email);

  if (!isLoggedIn) {
    const { signature, timestamp } = await fetch("/api/auth/sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ account: email }),
    }).then(r => r.json());

    await embed.login({
      type: "Email",
      account: email,
      signature,
      timestamp,
    });
  } else {
    await embed.login({
      type: "Email",
      account: email,
    });
  }
});

embed.on("routeChanged", fullPath => {
  console.log("Route changed to:", fullPath);
});

// Optional: Track page visit for TaskOn conversion analytics
// Only use if you need conversion rate analysis
// await trackVisit(); // For anonymous users
// or
// await trackVisit('Email', 'user@example.com'); // For known users
```
